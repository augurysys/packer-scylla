{
    "variables": {
        "project_id": "",
        "consul_url": "https://releases.hashicorp.com/consul/1.0.6/consul_1.0.6_linux_amd64.zip"
    },
    "builders": [
        {
          "type": "googlecompute",
          "project_id": "{{user `project_id`}}",
          "source_image_family": "centos-7",
          "zone": "us-east1-b",
          "image_family": "scylladb",
          "image_name": "scylladb-{{timestamp}}",
          "ssh_username": "admin",
          "subnetwork": "default"
        }
    ],
    "provisioners": [
        {
            "type": "file",
            "source": "data_disk.service",
            "destination": "/tmp/data_disk.service"
        },
        {
            "type": "file",
            "source": "scylla-settings.service",
            "destination": "/tmp/scylla-settings.service"
        },
        {
            "type": "file",
            "source": "scylla-settings.sh",
            "destination": "/tmp/scylla-settings.sh"
        },
        {
            "type": "file",
            "source": "consul.service",
            "destination": "/tmp/consul.service"
        },
        {
            "type": "file",
            "source": "scylladb-repair.cron",
            "destination": "/tmp/scylladb-repair.cron"
        },
        {
            "type": "shell",
            "inline": [
                "#!/bin/bash",
                "sudo yum remove -y abrt",
                "sudo yum install -y epel-release wget unzip",
                "sudo wget -O /etc/yum.repos.d/scylla.repo http://repositories.scylladb.com/scylla/repo/c0ff342242434efe6a757722c44da73f/centos/scylladb-2.1.repo",
                "sudo yum install -y scylla",
                "sudo mv /tmp/data_disk.service /etc/systemd/system/data_disk.service",
                "sudo mv /tmp/scylla-settings.service /etc/systemd/system/scylla-settings.service",
                "sudo mv /tmp/scylla-settings.sh /usr/local/bin",
                "sudo chmod +x /usr/local/bin/scylla-settings.sh",
                "sudo systemctl enable data_disk.service",
                "sudo systemctl enable scylla-settings.service",
                "sudo sed -ie 's|SCYLLA_HOME=/var/lib/scylla|SCYLLA_HOME=/mnt/disks/data/scylla|' /etc/sysconfig/scylla-server",
                "sudo sed -ie 's|/var/lib/scylla|/mnt/disks/data/scylla|g' /etc/scylla/scylla.yaml",
                "sudo systemctl enable scylla-server.service",
                "sudo setenforce 0",
                "sudo mv /tmp/consul.service /etc/systemd/system/consul.service && sudo systemctl enable consul.service",

                "wget -O /tmp/consul.zip {{user `consul_url`}} && sudo unzip /tmp/consul.zip -d /usr/local/bin/",
                "sudo mv /tmp/scylladb-repair.cron /etc/cron.weekly/scylladb-repair.cron",
                "sudo chmod +x /etc/cron.weekly/scylladb-repair.cron",
                "sudo setenforce 1"
            ]
        }
    ]
}
